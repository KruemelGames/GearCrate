<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Inventory Manager - Bulk Import</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>ğŸš€ Star Citizen Inventory Manager</h1>
            <div class="stats" id="stats">
                <span>Items: <strong id="total-items">0</strong></span>
                <span>Gesamt: <strong id="total-count">0</strong></span>
                <span>Cache: <strong id="cache-size">0 MB</strong></span>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="navigation">
            <a href="index.html" class="nav-link">ğŸ“¦ Inventar</a>
            <a href="bulk-import.html" class="nav-link active">âš¡ Bulk Import</a>
        </nav>

        <!-- Main Content -->
        <div class="content">
            <!-- Import Section -->
            <div class="bulk-import-section">
                <h2>Bulk Import von CStone.space</h2>
                <p class="info-text">
                    Importiere FPS-RÃ¼stungsteile - entweder automatisch oder durch Kopieren der Tabelle.
                </p>

                <!-- Import Method Selection -->
                <div class="import-method-box">
                    <h3>Import-Methode wÃ¤hlen:</h3>
                    <div class="method-buttons">
                        <button id="method-scrape" class="method-btn active">ğŸŒ Automatisch (Scraping)</button>
                        <button id="method-paste" class="method-btn">ğŸ“‹ Manuell (Copy & Paste)</button>
                    </div>
                </div>

                <!-- Scraping Method -->
                <div id="scraping-section" class="import-section-method">
                    <!-- Categories Selection -->
                    <div class="categories-box">
                        <h3>Kategorien auswÃ¤hlen:</h3>
                        <div class="category-list">
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Torsos">
                                <span>ğŸ¦º Torsos</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Arms">
                                <span>ğŸ§¤ Arms</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Legs">
                                <span>ğŸ‘– Legs</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Helmets">
                                <span>ğŸª– Helmets</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Backpacks">
                                <span>ğŸ’ Backpacks</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Undersuits">
                                <span>ğŸ‘” Undersuits</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="HÃ¼te">
                                <span>ğŸ© HÃ¼te</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Brillen">
                                <span>ğŸ‘“ Brillen</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Handschuhe">
                                <span>ğŸ§¤ Handschuhe</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Jacken">
                                <span>ğŸ§¥ Jacken</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="T-Shirts">
                                <span>ğŸ‘• T-Shirts</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Jumpsuits">
                                <span>ğŸ¦º Jumpsuits</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Hosen (Kleidung)">
                                <span>ğŸ‘– Hosen (Kleidung)</span>
                            </label>
                            <label class="category-item">
                                <input type="checkbox" class="category-checkbox" value="Schuhe">
                                <span>ğŸ‘Ÿ Schuhe</span>
                            </label>
                        </div>
                    </div>

                    <!-- Import Controls -->
                    <div class="import-controls">
                        <button id="start-import-btn" class="btn-primary btn-large">
                            ğŸš€ Import starten
                        </button>
                        <button id="stop-import-btn" class="btn-danger btn-large" style="display: none;">
                            â›” Import abbrechen
                        </button>
                    </div>
                </div>

                <!-- Paste Method -->
                <div id="paste-section" class="import-section-method" style="display: none;">
                    <div class="paste-box">
                        <h3>Tabellendaten einfÃ¼gen:</h3>
                        <p class="info-text-small">
                            Kopiere die Tabelle von CStone.space und fÃ¼ge sie hier ein. 
                            Jede Zeile sollte: Name, Type, ... enthalten.
                        </p>
                        <textarea id="paste-textarea" placeholder="Hier Tabellendaten einfÃ¼gen...
Beispiel:
Odyssey II Helmet Starcrossed	Flight Helmet	10%	-30	60	15200	81	0	15700
Corbel Helmet Mire	Heavy Armor	40%	-70	100	26800	145.8	0	19000"></textarea>
                        
                        <!-- Item Type Selection -->
                        <div class="type-selection">
                            <label for="paste-item-type">Item-Typ:</label>
                            <select id="paste-item-type">
                                <option value="Torso">Torso</option>
                                <option value="Arms">Arms</option>
                                <option value="Legs">Legs</option>
                                <option value="Helmet" selected>Helmet</option>
                                <option value="Backpack">Backpack</option>
                                <option value="Undersuit">Undersuit</option>
                                <option value="Hat">Hut</option>
                                <option value="Eyes">Brille</option>
                                <option value="Hands">Handschuhe</option>
                                <option value="Jacket">Jacke</option>
                                <option value="Shirt">T-Shirt</option>
                                <option value="Jumpsuit">Jumpsuit</option>
                                <option value="Pants">Hose (Kleidung)</option>
                                <option value="Shoes">Schuhe</option>
                            </select>
                        </div>

                        <div class="import-controls">
                            <button id="paste-import-btn" class="btn-primary btn-large">
                                ğŸ“¥ Daten importieren
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Progress Display -->
                <div id="import-progress" class="import-progress hidden">
                    <h3>Import lÃ¤uft...</h3>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div class="progress-stats">
                        <span>Fortschritt: <strong id="progress-current">0</strong> / <strong id="progress-total">0</strong></span>
                        <span>Importiert: <strong id="progress-imported">0</strong></span>
                        <span>Ãœbersprungen: <strong id="progress-skipped">0</strong></span>
                    </div>
                    <div id="current-category" class="current-category"></div>
                </div>

                <!-- Log Display -->
                <div id="import-log" class="import-log">
                    <h3>Import-Log</h3>
                    <div id="log-content" class="log-content">
                        <div class="log-entry log-info">Bereit zum Import...</div>
                    </div>
                </div>

                <!-- Database Management Section -->
                <div class="database-management">
                    <h3>âš ï¸ Datenbank-Verwaltung</h3>
                    <p class="info-text-small">
                        <strong>Achtung:</strong> Diese Aktionen kÃ¶nnen nicht rÃ¼ckgÃ¤ngig gemacht werden!
                    </p>
                    <div class="db-actions">
                        <button id="clear-inventory-btn" class="btn-warning btn-large">
                            ğŸ—‘ï¸ Inventar leeren
                        </button>
                        <button id="delete-all-btn" class="btn-danger btn-large">
                            ğŸš« Datenbank lÃ¶schen
                        </button>
                        <button id="clear-cache-btn" class="btn-warning btn-large">
                            ğŸ—ƒï¸ Cache leeren
                        </button>
                    </div>
                    <div class="db-info">
                        <p><strong>Inventar leeren:</strong> Setzt alle Item-ZÃ¤hler auf 0 (Items bleiben in Datenbank)</p>
                        <p><strong>Datenbank lÃ¶schen:</strong> LÃ¶scht ALLE Items komplett aus der Datenbank</p>
                        <p><strong>Cache leeren:</strong> LÃ¶scht alle heruntergeladenen Bilder</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="api-adapter.js"></script>
    <script>
        // Bulk Import Controller
        const BulkImport = {
            isRunning: false,
            shouldStop: false,
            stats: {
                total: 0,
                current: 0,
                imported: 0,
                skipped: 0
            },

            categoryMapping: {
                'Torsos': { url: 'FPSArmors?type=Torsos', type: 'Torso' },
                'Arms': { url: 'FPSArmors?type=Arms', type: 'Arms' },
                'Legs': { url: 'FPSArmors?type=Legs', type: 'Legs' },
                'Helmets': { url: 'FPSArmors?type=Helmets', type: 'Helmet' },
                'Backpacks': { url: 'FPSArmors?type=Backpacks', type: 'Backpack' },
                'Undersuits': { url: 'FPSArmors?type=Undersuits', type: 'Undersuit' },
                'HÃ¼te': { url: 'FPSClothes?type=Hat', type: 'Hat' },
                'Brillen': { url: 'FPSClothes?type=Eyes', type: 'Eyes' },
                'Handschuhe': { url: 'FPSClothes?type=Hands', type: 'Hands' },
                'Jacken': { url: 'FPSClothes?type=Jacket', type: 'Jacket' },
                'T-Shirts': { url: 'FPSClothes?type=Shirt', type: 'Shirt' },
                'Jumpsuits': { url: 'FPSClothes?type=Jumpsuit', type: 'Jumpsuit' },
                'Hosen (Kleidung)': { url: 'FPSClothes?type=Legs', type: 'Pants' },
                'Schuhe': { url: 'FPSClothes?type=Feet', type: 'Shoes' }
            },

            init() {
                // Method switching
                document.getElementById('method-scrape').addEventListener('click', () => this.switchMethod('scrape'));
                document.getElementById('method-paste').addEventListener('click', () => this.switchMethod('paste'));
                
                // Scraping import
                document.getElementById('start-import-btn').addEventListener('click', () => this.startScraping());
                document.getElementById('stop-import-btn').addEventListener('click', () => this.stop());
                
                // Paste import
                document.getElementById('paste-import-btn').addEventListener('click', () => this.startPaste());
                
                // Database management
                document.getElementById('clear-inventory-btn').addEventListener('click', () => this.clearInventory());
                document.getElementById('delete-all-btn').addEventListener('click', () => this.deleteAllItems());
                document.getElementById('clear-cache-btn').addEventListener('click', () => this.clearCache());
                
                this.loadStats();
            },

            switchMethod(method) {
                // Update buttons
                document.getElementById('method-scrape').classList.toggle('active', method === 'scrape');
                document.getElementById('method-paste').classList.toggle('active', method === 'paste');
                
                // Show/hide sections
                document.getElementById('scraping-section').style.display = method === 'scrape' ? 'block' : 'none';
                document.getElementById('paste-section').style.display = method === 'paste' ? 'block' : 'none';
            },

            async loadStats() {
                try {
                    const stats = await api.getStats();
                    document.getElementById('total-items').textContent = stats.total_unique_items;
                    document.getElementById('total-count').textContent = stats.total_item_count;
                    document.getElementById('cache-size').textContent = stats.cache_size_mb + ' MB';
                } catch (error) {
                    console.error('Fehler beim Laden der Stats:', error);
                }
            },

            getSelectedCategories() {
                const checkboxes = document.querySelectorAll('.category-checkbox:checked');
                return Array.from(checkboxes).map(cb => cb.value);
            },

            log(message, type = 'info') {
                const logContent = document.getElementById('log-content');
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                logContent.appendChild(entry);
                logContent.scrollTop = logContent.scrollHeight;
            },

            updateProgress() {
                const percent = this.stats.total > 0 ? (this.stats.current / this.stats.total) * 100 : 0;
                document.getElementById('progress-fill').style.width = percent + '%';
                document.getElementById('progress-current').textContent = this.stats.current;
                document.getElementById('progress-total').textContent = this.stats.total;
                document.getElementById('progress-imported').textContent = this.stats.imported;
                document.getElementById('progress-skipped').textContent = this.stats.skipped;
            },

            async startScraping() {
                if (this.isRunning) return;

                const categories = this.getSelectedCategories();
                if (categories.length === 0) {
                    alert('Bitte mindestens eine Kategorie auswÃ¤hlen!');
                    return;
                }

                this.isRunning = true;
                this.shouldStop = false;
                this.stats = { total: 0, current: 0, imported: 0, skipped: 0 };

                // UI Updates
                document.getElementById('start-import-btn').style.display = 'none';
                document.getElementById('stop-import-btn').style.display = 'inline-block';
                document.getElementById('import-progress').classList.remove('hidden');
                document.getElementById('log-content').innerHTML = '';

                this.log('Import gestartet...', 'success');
                this.log(`AusgewÃ¤hlte Kategorien: ${categories.join(', ')}`, 'info');

                try {
                    for (const category of categories) {
                        if (this.shouldStop) break;

                        const categoryData = this.categoryMapping[category];
                        await this.importCategory(category, categoryData);
                    }

                    if (!this.shouldStop) {
                        this.log('âœ… Import erfolgreich abgeschlossen!', 'success');
                        this.log(`Importiert: ${this.stats.imported} | Ãœbersprungen: ${this.stats.skipped}`, 'success');
                    } else {
                        this.log('âš ï¸ Import wurde abgebrochen', 'warning');
                    }
                } catch (error) {
                    this.log(`âŒ Fehler beim Import: ${error.message}`, 'error');
                    console.error(error);
                }

                // Cleanup
                this.isRunning = false;
                document.getElementById('start-import-btn').style.display = 'inline-block';
                document.getElementById('stop-import-btn').style.display = 'none';
                
                // Reload stats
                await this.loadStats();
            },

            async startPaste() {
                const textarea = document.getElementById('paste-textarea');
                const itemType = document.getElementById('paste-item-type').value;
                const text = textarea.value.trim();

                if (!text) {
                    alert('Bitte Tabellendaten einfÃ¼gen!');
                    return;
                }

                this.isRunning = true;
                this.stats = { total: 0, current: 0, imported: 0, skipped: 0 };

                // UI Updates
                document.getElementById('import-progress').classList.remove('hidden');
                document.getElementById('log-content').innerHTML = '';

                this.log('Parse Tabellendaten...', 'info');

                // Parse table data
                const lines = text.split('\n').filter(line => line.trim());
                const items = [];

                for (const line of lines) {
                    // Split by tab or multiple spaces
                    const parts = line.split(/\t+|\s{2,}/);
                    
                    if (parts.length > 0) {
                        const name = parts[0].trim();
                        if (name && name !== 'â' && !name.toLowerCase().includes('name')) {
                            items.push({
                                name: name,
                                type: itemType
                            });
                        }
                    }
                }

                this.log(`Gefunden: ${items.length} Items`, 'info');
                this.stats.total = items.length;
                this.updateProgress();

                // Import items
                for (const item of items) {
                    if (this.shouldStop) break;

                    try {
                        const existing = await api.getItem(item.name);
                        
                        if (existing) {
                            this.log(`â­ï¸  "${item.name}" bereits vorhanden`, 'warning');
                            this.stats.skipped++;
                        } else {
                            const result = await api.addItem(item.name, item.type, null, null, 0); // initial_count=0

                            if (result.success) {
                                this.log(`âœ… "${item.name}" importiert`, 'success');
                                this.stats.imported++;
                            } else {
                                this.log(`âŒ Fehler bei "${item.name}": ${result.error}`, 'error');
                            }
                        }
                    } catch (error) {
                        this.log(`âŒ Fehler bei "${item.name}": ${error.message}`, 'error');
                    }

                    this.stats.current++;
                    this.updateProgress();
                    await this.sleep(100);
                }

                this.log('âœ… Import abgeschlossen!', 'success');
                this.log(`Importiert: ${this.stats.imported} | Ãœbersprungen: ${this.stats.skipped}`, 'success');
                
                this.isRunning = false;
                await this.loadStats();
            },

            async importCategory(categoryName, categoryData) {
                this.log(`ğŸ“¦ Starte Kategorie: ${categoryName}`, 'info');
                document.getElementById('current-category').textContent = `Aktuelle Kategorie: ${categoryName}`;

                try {
                    // Call backend API to get all items from category
                    const response = await fetch(`/api/bulk-import/${encodeURIComponent(categoryData.url)}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const items = await response.json();
                    this.log(`Gefunden: ${items.length} Items in ${categoryName}`, 'info');

                    this.stats.total += items.length;
                    this.updateProgress();

                    // Import jedes Item
                    for (const item of items) {
                        if (this.shouldStop) break;

                        try {
                            // Check if exists
                            const existing = await api.getItem(item.name);
                            
                            if (existing) {
                                this.log(`â­ï¸  "${item.name}" bereits vorhanden`, 'warning');
                                this.stats.skipped++;
                            } else {
                                // Add new item with count=0
                                const result = await api.addItem(
                                    item.name,
                                    categoryData.type,
                                    item.image_url,
                                    null,  // notes
                                    0      // initial_count = 0
                                );

                                if (result.success) {
                                    this.log(`âœ… "${item.name}" importiert`, 'success');
                                    this.stats.imported++;
                                } else {
                                    this.log(`âŒ Fehler bei "${item.name}": ${result.error}`, 'error');
                                }
                            }
                        } catch (itemError) {
                            this.log(`âŒ Fehler bei "${item.name}": ${itemError.message}`, 'error');
                        }

                        this.stats.current++;
                        this.updateProgress();

                        // Rate limiting
                        await this.sleep(200);
                    }

                    this.log(`âœ… Kategorie ${categoryName} abgeschlossen`, 'success');
                } catch (error) {
                    this.log(`âŒ Fehler bei Kategorie ${categoryName}: ${error.message}`, 'error');
                    throw error;
                }
            },

            stop() {
                this.shouldStop = true;
                this.log('Import wird abgebrochen...', 'warning');
            },

            async clearInventory() {
                if (!confirm('âš ï¸ Inventar wirklich leeren?\n\nAlle Item-ZÃ¤hler werden auf 0 gesetzt.\nDie Items bleiben in der Datenbank.')) {
                    return;
                }

                try {
                    const result = await api.clearInventory();
                    if (result.success) {
                        this.log(`âœ“ Inventar geleert: ${result.affected} Items auf 0 gesetzt`, 'success');
                        await this.loadStats();
                        alert(`Inventar geleert!\n${result.affected} Items wurden auf Count 0 gesetzt.`);
                    } else {
                        this.log(`âœ— Fehler: ${result.error}`, 'error');
                        alert('Fehler beim Leeren des Inventars');
                    }
                } catch (error) {
                    this.log(`âœ— Fehler: ${error.message}`, 'error');
                    console.error(error);
                }
            },

            async deleteAllItems() {
                if (!confirm('ğŸš« ACHTUNG: Datenbank wirklich komplett lÃ¶schen?\n\nALLE Items werden dauerhaft gelÃ¶scht!\nDieser Vorgang kann NICHT rÃ¼ckgÃ¤ngig gemacht werden!')) {
                    return;
                }

                // Double confirmation
                if (!confirm('Bist du dir ABSOLUT SICHER?\n\nSchreibe "JA" in das nÃ¤chste Feld um zu bestÃ¤tigen.')) {
                    return;
                }

                const confirmation = prompt('Gib "JA" ein um die Datenbank zu lÃ¶schen:');
                if (confirmation !== 'JA') {
                    alert('Abgebrochen.');
                    return;
                }

                try {
                    const result = await api.deleteAllItems();
                    if (result.success) {
                        this.log(`âœ“ Datenbank gelÃ¶scht: ${result.deleted} Items entfernt`, 'success');
                        await this.loadStats();
                        alert(`Datenbank gelÃ¶scht!\n${result.deleted} Items wurden entfernt.`);
                    } else {
                        this.log(`âœ— Fehler: ${result.error}`, 'error');
                        alert('Fehler beim LÃ¶schen der Datenbank');
                    }
                } catch (error) {
                    this.log(`âœ— Fehler: ${error.message}`, 'error');
                    console.error(error);
                }
            },

            async clearCache() {
                if (!confirm('ğŸ—ƒï¸ Bild-Cache wirklich leeren?\n\nAlle heruntergeladenen Bilder werden gelÃ¶scht.\nSie werden beim nÃ¤chsten Aufruf neu heruntergeladen.')) {
                    return;
                }

                try {
                    const result = await api.clearCache();
                    if (result.success) {
                        this.log(`âœ“ Cache geleert`, 'success');
                        await this.loadStats();
                        alert('Bild-Cache wurde geleert!');
                    } else {
                        this.log(`âœ— Fehler: ${result.error}`, 'error');
                        alert('Fehler beim Leeren des Cache');
                    }
                } catch (error) {
                    this.log(`âœ— Fehler: ${error.message}`, 'error');
                    console.error(error);
                }
            },

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            BulkImport.init();
        });
    </script>
</body>
</html>
